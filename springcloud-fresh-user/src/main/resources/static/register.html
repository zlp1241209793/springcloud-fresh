<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>天天生鲜-注册</title>
<link rel="shortcut icon" href="images/copylogo.png">
<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/reg.css">
<link rel="stylesheet" href="css/unlock.css">
<link rel="stylesheet" href="css/foot.css">
</head>

<body>
	<div id="app">
		<!-- 注册布局 -->
		<div class="register_con">
			<div class="l_con fl">
				<a href="#" class="reg_logo fr"><img src="images/logo.png"></a>
				<div class="reg_slogan fr">足不出户 · 新鲜每一天</div>
				<div class="reg_banner fr"></div>
			</div>

			<div class="r_con fr">
				<div class="reg_title clearfix">
					<h1 class="fl">用户注册</h1>
					<a href="login.html" class="fr">登录</a>
				</div>
				<div class="reg_form clearfix">
					<form>
						<ul>
							<li>
								<label for="nickname">用户名:</label>
								<input type="text" name="nickname" v-model="nickName" @blur="checkAccount" placeholder="请输入您的用户名" required>
								<span class="error_tip"><span v-if="status[0]">账号格式错误...</span></span>
							</li>
							<li>
								<label for="pwd">密码:</label>
								<input type="password" name="pwd" v-model="pwd" @blur="checkPwd" placeholder="请输入6~15位字母、数字还可包含特殊字符">
								<span class="error_tip"><span v-if="status[1]">密码格式错误...</span></span>
							</li>
							<li>
								<label for="cpwd">确认密码:</label>
								<input type="password" name="cpwd" v-model="cpwd" @blur="checkCpwd" placeholder="请输入确认密码">
								<span class="error_tip"><span v-if="status[2]">两次密码输入不一致...</span></span>
							</li>
							<li>
								<label for="email">邮箱:</label>
								<input type="text" id="email" name="email" v-model="email" @blur="checkEmail" style="width: 300px;" placeholder="请输入有效的邮箱地址"> 
								<input type="button" id="getCode" name="" @click="sendCode" value="获取验证码">
								<span class="error_tip yzm_tip"><span v-if="status[3]">{{tip_email}}</span></span>
							</li>
							<li>
								<label for="yzm">验证码:</label>
								<input type="text" name="yzm" v-model="yzm" @blur="checkYzm" placeholder="请输入验证码">
								<span class="error_tip"><span v-if="status[4]">{{tip_yzm}}</span></span>
							</li>
							<li>
								<label for="tel">电话号码:</label>
								<input type="text" name="tel" v-model="tel" @blur="checkTel" placeholder="请输入以1开头的11位有效电话号码">
								<span class="error_tip"><span v-if="status[5]">手机号码格式错误...</span></span>
							</li>
							<li class="row">
								<!-- 滑块验证-->
								<div class="bar"></div>
							</li>
							<li class="agreement">
								<input type="checkbox" id="allow" name="allow" checked> 
								<label for="allow">同意<a href="#">"天天生鲜用户使用协议"</a></label> 
								<span class="error_tip2"><span v-if="checkbl">{{tip_info}}</span></span>
							</li>
							<li>
								<input type="button" id="reg" name="" @click="checkRegister" value="注 册"> 
							</li>
						</ul>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- 版权所有 -->
	<div class="footer">
		<div class="foot_link">
			<a href="#">关于我们</a> <span> | </span> <a href="#">联系我们</a> <span>
				| </span> <a href="#">招聘广告</a> <span> | </span> <a href="#">友情链接</a>
		</div>
		<p>CopyRight &copy; 2019 衡阳市源辰信息科技有限公司 All Rights Reserverd</p>
		<p>电话：0734-8355998 湘ICP备16015987号</p>
	</div>
	<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	<script src="js/vue.js"></script>
	<script src="js/axios.js"></script>
	<script src="js/qs.js"></script>
	<script src="js/unlock.js"></script>
	<script>
		$('.bar').slideToUnlock({});
		
		let vm = new Vue({
			el: "#app",
			data: {
				nickName: "",
				pwd: "",
				cpwd: "",
				yzm: "",
				tel: "",
				email: "",
				tip_email: "请输入您的注册邮箱...",
				tip_yzm: "请输入您获取到的验证码...",
				tip_info: "",
				checkbl: false,
				status:[false, false, false, false, false, false]
			},
			methods: {
				checkAccount: function() {
					if(this.nickName == '') {
						Vue.set(vm.status, 0, true);
						return;
					}
					
					// 规则
					let reg = /^[\u4e00-\u9fff\w]{2,16}$/;
					if (!reg.test(this.nickName)) {
						Vue.set(vm.status, 0, true);
						return;
					}
					Vue.set(vm.status, 0, false);
				},
				checkPwd: function() {
					//规则
					let reg = /^[\w@!#$%^&*~]{6,15}$/;
					//判断
					if(!reg.test(this.pwd)){
						Vue.set(vm.status, 1, true);
						return;
					}
					Vue.set(vm.status, 1, false);
				},
				checkCpwd: function() {
					if(this.pwd != this.cpwd){
						Vue.set(vm.status, 2, true);
						return;
					}
					Vue.set(vm.status, 2, false);
				},
				checkYzm: function() {
					//规则
					let reg = /^\d{6}$/;
					//判断
					if(!reg.test(this.yzm)){
						Vue.set(vm.status, 4, true);
						return;
					}
					Vue.set(vm.status, 4, false);
				},
				checkEmail: function() {
					//规则
					let reg = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;
					//判断
					if(!reg.test(this.email)){
						Vue.set(vm.status, 3, true);
						return;
					}
					Vue.set(vm.status, 3, false);
				},
				checkTel: function() {
					//规则
					let reg = /^1(3|4|5|6|7|8|9)\d{9}$/;
					//判断
					if(!reg.test(this.tel)){
						Vue.set(vm.status, 5, true);
						return;
					}
					Vue.set(vm.status, 5, false);
				},
				sendCode: function() {
					if (this.status[3]) {
						return;
					}
					
					// 发送请求
					axios.post("member/code", qs.stringify({receive:this.email, name:this.nickName})).then(result =>{
						if (result.data.code == 200) { // 验证码发送成功
							// 倒计时
							var time = 180;
							var timetask = setInterval(function() {
								if (time > 0) {
									time --;
									$("#getCode").val(time + "S");
								} else {
									$("#getCode").removeAttr("disabled").val("重新获取");
									clearInterval(timetask);
								}
							}, 1000);
						} else if (result.data.code == 500) { // 验证码发送失败
							$("#getCode").removeAttr("disabled").val("重新获取");
							this.tip_email = "邮件发送失败，点击重新获取...";
						}
					})
				},
				checkRegister: function() {
					if ($.inArray(true, this.status) >= 0) { // 说明数组中有true值，即有的检验未通过
						this.checkbl = true;
						this.tip_info = "您输入的信息有误,请检查后重新提交...";
						return;
					} 
					this.checkbl = false;
					// 发送请求
					axios.post("member/reg", qs.stringify({nickName:this.nickName, pwd:this.pwd, realName:this.yzm, tel:this.tel, email:this.email})).then(result => {
						if (result.data.code == 501) {
							this.checkbl = true;
							this.tip_info = "验证码错误...";
						} else if (result.data.code == 200) {
							// 先获取是从哪个页面跳过来的
							let temp = document.referrer; // 获取来源路径
							// 如果是直接访问的登录界面或者是从注册界面来的，那么默认访问首页
							if (temp == "" || temp == undefined || temp.indexOf("register.html")) {
								location.href="/view/index.html";
							} else {
								history.go(-1);
							}
						} else {
							this.checkbl = true;
							this.info = "账号或密码错误...";
						}
					})
				}
			}
		})
	</script>
</body>
</html>
